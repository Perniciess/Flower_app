.# Оценка готовности к продакшену

Проект структурно чистый — архитектура по слоям выдержана, импорты консистентны, ORM используется без сырых запросов. Но есть ряд проблем, которые нужно закрыть до продакшена.

---

## CRITICAL — блокирует деплой

### 1. Rate limiter хранит состояние в памяти процесса
`app/core/limiter.py` — `storage_uri="memory://"`. При нескольких воркерах (uvicorn/gunicorn) лимиты не шарятся между процессами — каждый воркер считает отдельно. Нужно переключить на Redis.

### 2. Rate limiting отсутствует на большинстве эндпоинтов
Защищены только `auth` и `orders`. Без лимитов остались: `products`, `categories`, `carts`, `favourites`, `users`, `discounts`, `pickups`. Карт-эндпоинты особенно уязвимы — можно спамить добавление товаров.

### 3. `delete_pickup_point` — DELETE без RETURNING
`app/repository/pickups_repository.py:43-46` — функция всегда возвращает `False`.

### 4. Нет управления остатками / инвентарём
В модели `Product` нет поля количества. Заказы создаются без проверки наличия. При конкурентных запросах возможен overselling.

### 5. Создание заказа + платёж не атомарны
`app/service/orders_service.py:81-93` — заказ создаётся в БД, затем вызывается внешний API Yookassa. Если API упадёт — в базе остаётся заказ без платежа. Нужна стратегия компенсации (отмена заказа при ошибке платежа) или паттерн outbox.

---

## HIGH — серьёзные проблемы

### 6. Redis: `maxmemory-policy allkeys-lru`
`docker/docker-compose.yaml` — при нехватке памяти Redis начнёт вытеснять ключи, включая токены верификации, чёрный список JWT и данные сброса пароля. Нужен `noeviction` или `volatile-lru` (только ключи с TTL).

### 7. Webhook Yookassa — нет проверки подписи
`app/core/deps.py:69-76` — проверяется только IP через `X-Forwarded-For`, который можно подделать без валидации цепочки прокси. Нужна проверка HMAC-подписи запроса.

### 8. Webhook не проверяет сумму платежа
`app/service/orders_service.py:98-120` — при `payment.succeeded` заказ помечается оплаченным без сверки суммы. Если сумма в вебхуке отличается от суммы заказа — это не обнаружится.

### 9. Ошибки раскрывают внутренние данные
`app/core/exceptions.py` — сообщения вида `Пользователь с ID=5 не найден`, `phone_number=+7... уже существует`. В продакшене нужны обезличенные сообщения.

### 10. Cookie без ограничения `path`
`app/utils/cookie.py` — refresh_token и access_token отправляются на все пути. Нужно ограничить: `path="/api"`.

### 11. CORS: `allow_headers=["*"]` + `allow_credentials=True`
`app/main.py:73-80` — ослабляет CSRF-защиту. Нужен явный список заголовков.

---

## MEDIUM — стоит исправить

### 12. Нет индексов на часто фильтруемых колонках
- `Order.user_id` — нет индекса, а по нему идёт фильтрация в истории заказов
- `Delivery.order_id` — FK без индекса
- `Favourite.product_id` — нет индекса
- `Product.type` — фильтруется, но не проиндексирован

### 13. Нет глобального обработчика исключений
`app/main.py` — обрабатывается только `RateLimitExceeded`. Необработанные ошибки SQLAlchemy/Pydantic могут вернуть стектрейс клиенту.

### 14. `GET /products/images` возвращает список без пагинации
`app/api/v1/products_router.py:112-123` — при большом числе изображений загрузит всё в память.

### 15. TTL из Redis не валидируется
`app/service/auth_service.py:247-252` — `ttl = await redis.ttl(...)` может вернуть `-2` (ключ не существует), после чего `redis.set(..., ex=-2)` создаст невалидный ключ.

### 16. `UserUpdate.password` без `max_length`
`app/schemas/users_schema.py:41` — без ограничения можно отправить мегабайтную строку, Argon2 будет хешировать её долго (DoS через хеширование).

### 17. `create_order` возвращает `200 OK` вместо `201 Created`
`app/api/v1/orders_router.py:26`

---

## LOW — на потом

- Телеграм-ссылки захардкожены в `config.py:79-80` — лучше вынести в `.env`
- Verification token 16 байт — достаточно для 5-минутного окна, но 32 было бы стандартнее
- `SECRET_KEY` без валидации минимальной длины
- `COOKIE_SECURE` по умолчанию `False` — нужно убедиться, что в продакшене выставлен `True`
- Неиспользуемая функция `get_active_for_product` в `discounts_repository.py:45`

---

## Что хорошо

- Чистая слоёная архитектура, консистентные именования
- Все SQL-запросы через ORM, инъекций нет
- Пароли хешируются Argon2
- JWT blacklist через Redis с TTL
- CSRF-защита реализована
- Загрузка изображений валидируется (расширение + magic bytes + размер)
- Сессии БД с пулингом, pre-ping, recycling
- Alembic настроен для async
